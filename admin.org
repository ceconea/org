* Administracion CECONEA
#+STARTUP: overview
* Actividades
** [2024-03-25 Mon] Instalacion backup rdiff-backup
zypper in rdiff-backup
script/rdiff_backup_home.sh

Agregar en el /etc/crontad:
0 4 * * 0 root /home/pulido/bin/rdiff_backup_home.sh

Aunque no hace falta reneuvo el cron:
systemctl status cron.service

** TODO [2024-03-13 Wed] Definicion de la red infiniband
** [2024-03-12 Tue] Baterias UPS APC
Se cambiaron las baterias.
** [2024-03-12 Tue] Baterias UPC EATON
Se desarmo porque habia un problema con un cooler

** ----------------------------------------
* TODOs Tareas cortas.
** TODO [2024-03-14 Thu] yakaira 10.11.12.60-59 no se puede acceder
** TODO [2024-03-15 Fri] grial4 10.11.12.7 problemas memoria GPU
* TODOs Largo plazo
** TODO [2024-03-14 Thu] Colocacion disco 4Tb en grial para backups
** TODO [2024-03-14 Thu] Pruebas de backups con distintas aplicaciones
*** Posibles aplicaciones
tar
rsync
rdiff-backup
rsnapshot
amanda
restic
borgbackup borweb
BackupPC.

**** tar
#+BEGIN_SRC bash :session :results output
#!/bin/sh
DATA=/backup/correo
LASTFULL=$DATA/full.tgz
SOURCE=/home
TODAY=`date “+%Y-%m-%d_%a”`
LASTDATE=`stat -c %y $LASTFULL`
DEST=$DATA/i$TODAY.tgz

# Borrar el incremental existente (si existe)
/bin/rm -f $DATA/i*

# Crear incremental
/bin/tar -chz –newer “$LASTDATE” -f $DEST $SOURCE

#+END_SRC

**** rdiff-backup
https://rdiff-backup.net/examples.html




I take it you are backing up a tarball which lives in a directory? if so, you'll have to restore the full file at some point in time. It usually works like:

rdiff-backup -r time file /destination/directory

so, for example, say you are trying to recover what's in a directory called example from your rdiff root dir:

cd /dir/of/rdiff/backup

rdiff-backup -r 3D example /tmp/newcopy

and it'll get you the copy as from 3 days ago and put it in /tmp/newcopy

read the man page, section RESTORING.

https://stackoverflow.com/questions/14500183/in-python-can-i-call-the-main-of-an-imported-module

#+BEGIN_SRC bash :session :results output
#!/bin/bash
# 
# Add to /etc/crontab:
# 30 3 * * 2,5  /home/pulido/bin/backuphome &> /var/log/bkp/`date +%m%d-%H%M`.log
# Correr crontab /etc/crontab????

# -------------
# CONFIG
# -------------

TIMESTAMP=`date +%m%d_%H%M`

# Backup Destination is a mounted partition on /mnt/ypy_3/backup (evito el lost+found haciendo 1 x 1 de paso se organiza mejor el rdiff?
DST2="/mnt/ypy2_4/backup/gica-rdiff-backup"

# The directory to backup
SRC2="/home/gica"

# How long to keep backup history
# In this case, the user can recover the backup state as it was 6 months ago (maxage)
MAXAGE="3M"

# Path to rdiff-backup binary
RDIFF="/usr/local/rdiff-backup/bin/rdiff-backup"

# Log file directory - needs to be created
LOG="/var/log/bkp"

# Some basic configuration options; see the manual
OPTIONS="--print-statistics"

# ---------------
# BACKUP
# ---------------

echo " -- $TIMESTAMP -- "

#if [ ! -d $DST ]
#then
#        touch $LOG/err.log
#        echo "$TIMESTAMP Invalid DST, will create... " >> /var/log/bkp/err.log
#        mkdir $DST
#fi
#
#if [ ! -d $SRC ]
#then
#        touch $LOG/err.log
#        echo "$TIMESTAMP Invalid SRC, aborting... " >> /var/log/bkp/err.log
#        mount $DISK -o remount,ro
#        exit 1
#fi

echo "Backup: $RDIFF $OPTIONS $SRC $DST"

# GICA
sudo -u gica $RDIFF $OPTIONS $SRC2 $DST2
# It went well, remove stuff older than MAXAGE
if [ $? -eq 0 ]; then
        sudo -u gica $RDIFF --force --remove-older-than $MAXAGE $DST2
else
        echo $? > $LOG/fail$TIMESTAMP.log
fi



echo "-- EOF --"


#+END_SRC

** TODO [2024-03-14 Thu] Generacion de venv general con todas las aplicaciones.
** TODO [2024-03-16 Sat] Redefinicion de las redes
10.11.12. 1-10 grials
10.11.12.11-20 ypy, huayra, ysyry etc
10.11.12.20-30 pcs
10.11.12.30-40 laptops
10.11.12.40-50 laptops visitas
10.11.12.100   huayra super
10.11.12.150   huayra siasa
10.11.12.200   sun
10.11.12.230-254 switches/ups/impresoras

Replicar en la red 13 (excepto las maquinas que no estan conectadas).

nombres: sun2 sun_ib2, sun_nf2 ?

Si quisieramos mandar el trafico de calculo y nfs por la red 13? como lo forzamos? y solo la 12 para acceso.

* Deteccion de problemas.
** TODO [2024-03-13 Wed] La red 10.11.13.x se accede desde la 10.11.12.x
deberia ser privada?
Lo que esta sucediendo es que se accede a la 13 desde la 12 por el port forwarding y desde la 12 a la 13 por lo que no son redes independientes y se saturan entre si.
Para intentar independizarlas:
https://serverfault.com/questions/877449/how-to-forbid-forwarding-packets-to-private-network-addresses-via-interface
iptables -A FORWARD -o eth0 -j REJECT
(hay que decirle que no haga FORWARD desde la placa de la red 13

** TODO [2024-03-14 Thu] Problemas en gpu grial4
RuntimeError: CUDA error: an illegal memory access was encountered
CUDA kernel errors might be asynchronously reported at some other API call, so the stacktrace below might be incorrect.
For debugging consider passing CUDA_LAUNCH_BLOCKING=1.
Compile with `TORCH_USE_CUDA_DSA` to enable device-side assertions.

En principio esto es porque se queda sin memoria, lo raro es que no deberia quedarse sin memoria??? Se puede probar con:
torch.cuda.empty_cache()
pero se pierde performance

probe con
export CUDA_LAUNCH_BLOCKING=1
para ver si sigue dando el error

* Reportes Rodrigo
* Reportes Manuel
** [2024-03-23 Sat] NIS con firewalld

** [2024-03-23 Sat] Evitar el forwarding a la red 10.11.13
iptables -A FORWARD -d 10.11.13.0/24 -j REJECT

https://medium.com/skilluped/what-is-iptables-and-how-to-use-it-781818422e52
iptables -L
systemctl disable --now firewalld.
https://forums.opensuse.org/t/make-current-iptables-persistent/27753
https://ghost.pegasi.fi/wiki/doku.php?id=tips_and_howtos:opensuse_iptables
Explica como hacer persistente las reglas de iptables
https://ghost.pegasi.fi/wiki/doku.php?id=tips_and_howtos:opensuse_iptables

https://unix.stackexchange.com/questions/493275/firewalld-to-allow-routing-without-nat-between-nics
firewall-cmd --permanent --direct --add-rule ipv4 filter FORWARD 0 -i eth1 -o eth2  -j ACCEPT
firewall-cmd --permanent --direct --add-rule ipv4 filter FORWARD 0 -i eth2 -o eth1  -j ACCEPT
limit the forwarding to SSH, HTTPS and HTTP ports. I

** [2024-03-14 Thu] Instalacion grial4
blabla

** [2024-03-16 Sat] Borro placa externa yakaira

│10.40.60.207▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ /24▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒ yakaira▒▒▒▒▒▒▒▒▒▒▒▒

la remuevo porque no encuentra el proxy para instalar con el pip
